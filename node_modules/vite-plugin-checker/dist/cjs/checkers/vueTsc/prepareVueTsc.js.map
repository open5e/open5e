{"version":3,"sources":["../../../../src/checkers/vueTsc/prepareVueTsc.ts","../../../../../../node_modules/.pnpm/tsup@6.2.2_typescript@4.5.5/node_modules/tsup/assets/cjs_shims.js"],"sourcesContent":["import fsExtra from 'fs-extra'\nimport { createRequire } from 'module'\nimport path, { dirname } from 'path'\nimport { fileURLToPath } from 'url'\nimport { writeFile, access, readFile, rm } from 'fs/promises'\n\nconst { copy, mkdir } = fsExtra\nconst _require = createRequire(import.meta.url)\n\n// isomorphic __dirname https://antfu.me/posts/isomorphic-dirname\nconst _filename = fileURLToPath(import.meta.url)\nconst _dirname = dirname(_filename)\n\nlet proxyApiPath: string\nlet createProgramFunction: string\ntry {\n  // vue-tsc exposes the proxy in vue-tsc/out/index after v1.0.14\n  proxyApiPath = _require.resolve('vue-tsc/out/index')\n  createProgramFunction = 'createProgram'\n} catch (e) {\n  // @deprecated\n  // will be removed in 0.6.0\n  // vue-tsc exposes the proxy in vue-tsc/out/proxy before v1.0.14\n  proxyApiPath = _require.resolve('vue-tsc/out/proxy')\n  createProgramFunction = 'createProgramProxy'\n}\n\nexport async function prepareVueTsc() {\n  // 1. copy typescript to folder\n  const targetTsDir = path.resolve(_dirname, 'typescript-vue-tsc')\n  const vueTscFlagFile = path.resolve(targetTsDir, 'vue-tsc-resolve-path')\n\n  let shouldBuildFixture = true\n  try {\n    await access(targetTsDir)\n    const targetTsVersion = _require(path.resolve(targetTsDir, 'package.json')).version\n    const currTsVersion = _require('typescript/package.json').version\n    // check fixture versions before re-use\n    await access(vueTscFlagFile)\n    const fixtureFlagContent = await readFile(vueTscFlagFile, 'utf8')\n    if (targetTsVersion === currTsVersion && fixtureFlagContent === proxyApiPath) {\n      shouldBuildFixture = false\n    }\n  } catch (e) {\n    // no matter what error, we should rebuild the fixture\n    shouldBuildFixture = true\n  }\n\n  if (shouldBuildFixture) {\n    await rm(targetTsDir, { force: true, recursive: true })\n    await mkdir(targetTsDir)\n    const sourceTsDir = path.resolve(_require.resolve('typescript'), '../..')\n    await copy(sourceTsDir, targetTsDir)\n    await writeFile(vueTscFlagFile, proxyApiPath)\n\n    // 2. sync modification of lib/tsc.js with vue-tsc\n    await overrideTscJs(_require.resolve(path.resolve(targetTsDir, 'lib/tsc.js')))\n  }\n\n  return { targetTsDir }\n}\n\nasync function overrideTscJs(tscJsPath: string) {\n  let result = await readFile(tscJsPath, 'utf8')\n  // #region copied from https://github.com/johnsoncodehk/volar/blob/54f7186485d79bc0e9b7ec59ecbc01d681ee5310/vue-language-tools/vue-tsc/bin/vue-tsc.js\n  const tryReplace = (search: RegExp | string, replace: string | ((v: string) => string)) => {\n    const before = result\n    // @ts-ignore\n    result = result.replace(search, replace)\n    if (before === result) {\n      throw 'Search string not found: ' + JSON.stringify(search.toString())\n    }\n  }\n\n  // add *.vue files to allow extensions\n  tryReplace(/supportedTSExtensions = .*(?=;)/, (s) => s + '.concat([[\".vue\"]])')\n  tryReplace(/supportedJSExtensions = .*(?=;)/, (s) => s + '.concat([[\".vue\"]])')\n  tryReplace(/allSupportedExtensions = .*(?=;)/, (s) => s + '.concat([[\".vue\"]])')\n\n  // proxy createProgram apis\n  tryReplace(\n    /function createProgram\\(.+\\) {/,\n    (s) =>\n      s + ` return require(${JSON.stringify(proxyApiPath)}).${createProgramFunction}(...arguments);` // tweak for compatibility, will be removed in 0.6.0\n  )\n  // #endregion\n\n  // change tsc command to module.exports\n  tryReplace(`ts.executeCommandLine(ts.sys, ts.noop, ts.sys.args);`, `module.exports = ts`)\n\n  await writeFile(tscJsPath, result)\n}\n","// Shim globals in cjs bundle\n// There's a weird bug that esbuild will always inject importMetaUrl\n// if we export it as `const importMetaUrl = ... __filename ...`\n// But using a function will not cause this issue\n\nconst getImportMetaUrl = () =>\n  typeof document === 'undefined'\n    ? new URL('file:' + __filename).href\n    : (document.currentScript && document.currentScript.src) ||\n      new URL('main.js', document.baseURI).href\n\nexport const importMetaUrl = /* @__PURE__ */ getImportMetaUrl()\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;ACKA,IAAM,mBAAmB,MACvB,OAAO,aAAa,cAChB,IAAI,IAAI,UAAU,UAAU,EAAE,OAC7B,SAAS,iBAAiB,SAAS,cAAc,OAClD,IAAI,IAAI,WAAW,SAAS,OAAO,EAAE;AAEpC,IAAM,gBAAgC,iCAAiB;ADX9D,sBAAoB;AACpB,oBAA8B;AAC9B,kBAA8B;AAC9B,iBAA8B;AAC9B,sBAAgD;AAEhD,MAAM,EAAE,MAAM,MAAM,IAAI,gBAAAA;AACxB,MAAM,eAAW,6BAAc,aAAe;AAG9C,MAAM,gBAAY,0BAAc,aAAe;AAC/C,MAAM,eAAW,qBAAQ,SAAS;AAElC,IAAI;AACJ,IAAI;AACJ,IAAI;AAEF,iBAAe,SAAS,QAAQ,mBAAmB;AACnD,0BAAwB;AAC1B,SAAS,GAAP;AAIA,iBAAe,SAAS,QAAQ,mBAAmB;AACnD,0BAAwB;AAC1B;AAEA,eAAsB,gBAAgB;AAEpC,QAAM,cAAc,YAAAC,QAAK,QAAQ,UAAU,oBAAoB;AAC/D,QAAM,iBAAiB,YAAAA,QAAK,QAAQ,aAAa,sBAAsB;AAEvE,MAAI,qBAAqB;AACzB,MAAI;AACF,cAAM,wBAAO,WAAW;AACxB,UAAM,kBAAkB,SAAS,YAAAA,QAAK,QAAQ,aAAa,cAAc,CAAC,EAAE;AAC5E,UAAM,gBAAgB,SAAS,yBAAyB,EAAE;AAE1D,cAAM,wBAAO,cAAc;AAC3B,UAAM,qBAAqB,UAAM,0BAAS,gBAAgB,MAAM;AAChE,QAAI,oBAAoB,iBAAiB,uBAAuB,cAAc;AAC5E,2BAAqB;AAAA,IACvB;AAAA,EACF,SAAS,GAAP;AAEA,yBAAqB;AAAA,EACvB;AAEA,MAAI,oBAAoB;AACtB,cAAM,oBAAG,aAAa,EAAE,OAAO,MAAM,WAAW,KAAK,CAAC;AACtD,UAAM,MAAM,WAAW;AACvB,UAAM,cAAc,YAAAA,QAAK,QAAQ,SAAS,QAAQ,YAAY,GAAG,OAAO;AACxE,UAAM,KAAK,aAAa,WAAW;AACnC,cAAM,2BAAU,gBAAgB,YAAY;AAG5C,UAAM,cAAc,SAAS,QAAQ,YAAAA,QAAK,QAAQ,aAAa,YAAY,CAAC,CAAC;AAAA,EAC/E;AAEA,SAAO,EAAE,YAAY;AACvB;AAEA,eAAe,cAAc,WAAmB;AAC9C,MAAI,SAAS,UAAM,0BAAS,WAAW,MAAM;AAE7C,QAAM,aAAa,CAAC,QAAyB,YAA8C;AACzF,UAAM,SAAS;AAEf,aAAS,OAAO,QAAQ,QAAQ,OAAO;AACvC,QAAI,WAAW,QAAQ;AACrB,YAAM,8BAA8B,KAAK,UAAU,OAAO,SAAS,CAAC;AAAA,IACtE;AAAA,EACF;AAGA,aAAW,mCAAmC,CAAC,MAAM,IAAI,qBAAqB;AAC9E,aAAW,mCAAmC,CAAC,MAAM,IAAI,qBAAqB;AAC9E,aAAW,oCAAoC,CAAC,MAAM,IAAI,qBAAqB;AAG/E;AAAA,IACE;AAAA,IACA,CAAC,MACC,IAAI,mBAAmB,KAAK,UAAU,YAAY,MAAM;AAAA,EAC5D;AAIA,aAAW,wDAAwD,qBAAqB;AAExF,YAAM,2BAAU,WAAW,MAAM;AACnC;","names":["fsExtra","path"]}